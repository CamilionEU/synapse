#!/usr/bin/make -f
#
# Build Debian package using https://github.com/spotify/dh-virtualenv
#

export DH_VIRTUALENV_INSTALL_ROOT=/opt/venvs
export CFLAGS=-march=x86-64
SNAKE=/usr/bin/python3
DH_VENV_ARGS=--install-suffix "matrix-synapse" \
			 --builtin-venv\
			 --setuptools \
			 --python $(SNAKE) \
			 --preinstall "setuptools>=40.6.3" \
			 --preinstall "pip>=18" \
			 --preinstall "wheel" \
			 --extra-pip-arg="--no-cache-dir" \
			 --extra-pip-arg="--compile"
PACKAGE=$(shell dh_listpackages)
VERSION=$(shell $(SNAKE) setup.py --version)
SDIST_DIR=debian/$(PACKAGE)-$(VERSION)
RELEASE_VERSION=$(VERSION)
DEBIAN_RELEASE_NUMBER=1
DISTRO_RELEASE=$(shell lsb_release -c -s)

override_dh_gencontrol:
	dh_gencontrol -- -v$(RELEASE_VERSION)-matrix$(DEBIAN_RELEASE_NUMBER)~$(DISTRO_RELEASE)

override_dh_strip:
	echo "No dhstrip"

override_dh_shlibdeps:
	echo "No shlibdeps"

override_dh_virtualenv:
	dh_virtualenv $(DH_VENV_ARGS)

%:
	dh $@ --with python-virtualenv
